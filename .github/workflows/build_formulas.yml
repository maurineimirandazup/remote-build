name: Build Formulas

on:
  push:
    branches:
      - 'releases/**'

jobs:
  prepare-release:
    runs-on: ubuntu-latest

    outputs:
      release_name: ${{ steps.check_release.outputs.release_name }}
      hash_autobuild: ${{ steps.check_status.outputs.hash_autobuild }}

    steps:
      - uses: actions/checkout@v2
      - id: check_release
        name: Check Release Name
        env:
          BRANCH_NAME: ${{ github.ref }}
        run: echo "::set-output name=release_name::${BRANCH_NAME/refs\/heads\/releases\//}"

      - id: validate_release
        name: Validate Release Name
        run: |
          echo "Release ${{ steps.check_release.outputs.release_name }}"

  build-linux:
    runs-on: ubuntu-latest
    needs: prepare-release
    steps:

      #Checkout files, build golang formulas
      - uses: actions/checkout@v2
      - uses: docker://ritclizup/rit-go-builder
      - id: build_formulas_go
        name: Build And Compress Formulas GO
        run: |
          git config core.fileMode false  
          git status
          chmod +x ./.github/build-go.sh
          ./.github/build-go.sh ritclizup/rit-go-builder
          git status

      #Build formulas python
      - uses: docker://maurineimirandazup/python3-pyinstaller-builder
      - id: build_formulas_python
        name: Build And Compress Formulas Python
        run: |
          git config core.fileMode false
          git status
          chmod +x ./.github/build-py.sh
          ./.github/build-py.sh maurineimirandazup/python3-pyinstaller-builder
          git status

      #Copy files do Artifact Folder
      - run: |
          mkdir ../build_linux
          cp -R . ../build_linux

      #Upload Artifacts
      - uses: actions/upload-artifact@master
        with:
          name: build_linux
          path: /home/runner/work/remote-build/build_linux

  build-mac:
    runs-on: macos-latest
    needs: prepare-release
    steps:
      #Build formulas python
      - uses: docker://maurineimirandazup/python3-pyinstaller-builder
      - id: build_formulas_python
        name: Build And Compress Formulas Python
        run: |
          git config core.fileMode false
          git status
          chmod +x ./.github/build-py.sh
          ./.github/build-py.sh maurineimirandazup/python3-pyinstaller-builder
          git status

      #Copy files do Artifact Folder
      - run: |
          mkdir ../build_mac
          cp -R . ../build_mac

      #Upload Artifacts
      - uses: actions/upload-artifact@master
        with:
          name: build_mac
          path: /home/runner/work/remote-build/build_mac



  generate-release:
    runs-on: ubuntu-latest
    needs: build-linux
    steps:
      - uses: actions/download-artifact@master
        with:
          name: build_linux
          path: ./  
      - id: clean_up_unnecessary_files
        name: Clean up unnecessary files
        run: |
          find ./ -maxdepth 1 -type f ! -name README.md ! -name LICENSE -delete
          rm -rf ./.circleci ./.github
          touch release_${{ needs.prepare-release.steps.check_release.outputs.release_name }}
          git status

      - id: commit_changes
        name: Commit Changes
        uses: EndBug/add-and-commit@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          signoff: true
          message: "Auto Build Formulas"

      - id: check_status
        name: Check Status
        run: |
          git status
          git --no-pager log -1 --format='%H'
          echo "::set-output name=hash_autobuild::$(git --no-pager log -1 --format='%H')"

      - id: create_release
        name: Create Release
        uses: actions/create-release@v1
#        uses: GongT/actions-recreate-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare-release.steps.check_release.outputs.release_name }}
          release_name: Release ${{ needs.prepare-release.steps.check_release.outputs.release_name }}
          draft: false
          prerelease: false
          commitish: ${{ needs.prepare-release.steps.check_status.outputs.hash_autobuild }}

# test2